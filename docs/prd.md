# Bybit 자동 마진 트레이딩 PRD

## 1) 목표 및 배경
- Bybit USDT-Perpetual 선물을 대상으로 하는 자동 마진 전략 봇을 제작한다.
- 손익의 일관성, 리스크 노출의 통제, 운영 자동화(무중단 실행, 알림, 사후 분석)를 1차 목표로 한다.
- MVP 단계에서는 단일 심볼 단일 전략(앵커드 VWAP 기반)으로 시작하고, 이후 다중 심볼·다중 전략/포트폴리오로 확장한다.
- 기술 스택: Python 3.13+, asyncio, httpx/websockets, pydantic(설정 검증), loguru(로깅) 우선.

## 2) 대상 및 가정
- 대상 사용자: 개인 또는 소규모 팀(운용자가 1~2명)으로 기본적인 파이썬/CLI 사용 능력이 있다.
- 가정/제약:
  - Bybit REST/WebSocket 사용. 네트워크 지연은 250ms 내외(일반 VPS 기준).
  - 계정은 API Key/Secret이 별도 보안 저장소 혹은 환경변수로 제공된다.
  - 전략은 앵커드 VWAP(기준 시점/가격에 따라 누적 거래대금 가중 평균) 기반으로 시작한다.
  - 테스트넷과 메인넷을 구분하고, 기본은 테스트넷으로 배포·검증한다.

## 3) 성공 지표(KPI)
- 연간 최대 낙폭(MDD) ≤ 15% (테스트넷/백테스트 기준 측정).
- 단일 포지션 손실 한도: 계좌 잔고 대비 1% 이내.
- 주간 가동률(봇 다운타임) ≥ 99%.
- 알림/로깅 누락률 1% 이하.

## 4) 범위
- In-scope:
  - 계정 연결, 시세/포지션/잔고 조회, 주문 실행/취소, 리스크 파라미터 설정.
  - 기본 전략 엔진(모멘텀 또는 MR) 1종 + 파라미터 설정/백테스트(간단).
- PnL/리스크 대시보드용 로그/메트릭 출력 및 알림(텔레그램 기본).
  - 기본 운영 스케줄러(주기적 헬스체크, 재시작)와 장애시 안전 정지(포지션 정리).
- Out-of-scope(초기):
  - 복수 거래소/현물/옵션, 고빈도/마켓메이킹, 고급 포트폴리오 최적화.
  - 온체인 연동, ML 기반 시그널, 커스텀 GUI.

## 5) 전략 및 리스크 개요
- 앵커드 VWAP 기본 로직:
  - 기준(앵커) 시점: 기본은 일봉 시가이나, 설정을 통해 임의 시각/가격(수동 지정) 또는 최근 극값/이벤트 캔들을 앵커로 선택 가능.
  - VWAP 획득: 자체 계산하지 않고 Bybit API에서 제공하는 VWAP/avgPrice 계열 필드(REST/WebSocket ticker) 값을 사용.
  - 시그널: 가격이 앵커드 VWAP 상단/하단 밴드(표준편차 또는 ATR 기반)를 기준으로 방향성 판단. 밴드 및 모멘텀 계산 기본 캔들 주기: 1시간봉(필요 시 주기 변경 가능).
  - 방향성/진입: 상승 시그널 발생 시 롱 진입, 하락 시그널 발생 시 숏 진입. 롱/숏 TP1은 각각 +3%/-3%(개별 설정), 도달 시 보유량 50% 익절.
  - 청산: 롱은 하락 시그널 발생 시 잔여 물량 전량 시장가 청산, 숏은 상승 시그널 시 전량 시장가 청산. 진입 후 곧바로 반대 시그널이 발생하면 즉시 전량 청산. 롱은 진입 후 -1% 도달 시 전량 손절, 숏은 진입 후 +1% 도달 시 전량 손절.
  - 재앵커링: 일봉 전환 또는 지정 이벤트 발생 시 VWAP 참조값 리셋(해당 시점 VWAP을 기준으로 이후 밴드 판단).
- 공통 리스크 제어:
  - 레버리지: 심볼별 기본 2~5x, 설정으로 변경 가능.
  - 증거금 모드: 교차/격리 선택, 기본 격리.
  - 주문 크기: 계좌 잔고의 p% 또는 고정 USDT 기준, 최대 notional 한도 설정.
  - 손절/이익실현: 진입 시점에 함께 설정(TP/SL) 또는 트레일링. 롱 익절 1차 50% at +3%(설정 가능), 숏 익절 1차 50% at -3%(설정 가능). 나머지는 추세 기반. 손절: 롱은 진입가 -1% 전량, 숏은 진입가 +1% 전량.
  - 청산 방지: 미체결 잔량 모니터링, 가격 괴리 감지 시 시장가 청산.

## 6) 기능 요구 사항
- 계정/보안
  - API Key/Secret 암호화 혹은 최소 환경변수 사용, 로그에 키 노출 금지.
  - 테스트넷/메인넷 스위치 가능, 기본 테스트넷.
- 시장/심볼 관리
  - 거래 심볼 목록 조회 및 화이트리스트 관리.
  - 레버리지/마진 모드 설정(REST: set-leverage, set-margin-mode).
- 데이터 수집
  - 시세: WebSocket(퍼페추얼) Ticker/OrderBook(Depth) 구독, 장애 시 REST fallback. Ticker의 VWAP/avgPrice 계열 필드를 구독.
  - 캔들: REST kline로 백필 및 주기적 업데이트(가격/거래량 기록용, VWAP 계산용으로는 사용하지 않음). 기본 주기: 1시간봉(예: 1m/3m/5m/15m/30m/60/120/240/360/720/D/W/M).
  - 서버 시간 동기화 및 시그니처 생성(서명 v3 기준).
- 포지션/주문
  - 주문 타입: 시장가/지정가, PostOnly/ReduceOnly 지원.
  - 포지션 조회 및 미체결 주문 관리, 강제청산 위험도 모니터링.
  - 대기/지정가 미체결이 전략 조건 변경 시 취소 혹은 리프라이스.
- 전략 실행
    - 시그널 계산 모듈: 앵커드 VWAP 파라미터(앵커 타입, 밴드 폭 k, 밴드 계산 방식 std/ATR, 사용 캔들 주기) 구성. VWAP 값은 거래소 API에서 조회/구독한 값을 사용(로컬 계산 없음).
    - 포지션 상태 머신: 진입 → 관리(롱: 익절 50% at +3%(설정), 손절 -1%; 숏: 익절 50% at -3%(설정), 손절 +1%; TP/SL/트레일링) → 청산(반대 시그널 전량) → 쿨다운. 로그에 가격/수량/수익률/잔고(현금·코인) 기록.
    - 슬리피지/수수료 고려한 기대 손익 계산.
- 리스크 관리
  - 계좌별 노출 상한: 총 합성 notional 및 심볼별 한도.
  - 실패 시 안전 동작: 연속 오류 N회 → 포지션 축소/청산 후 중단.
  - 가격 급변 감지: 스프레드/체결 속도 이상 시 신규 진입 차단.
- 모니터링/알림
  - 핵심 이벤트: 진입/청산, TP/SL, 오류/재시도, 지연/재연결, 잔고 변화.
  - 알림 채널: 텔레그램 기본(봇 토큰/채팅 ID 설정), 메시지 포맷 표준화.
  - 주기 헬스체크: WebSocket 연결 상태, 시계 동기화, 잔고/포지션 표본 점검. 백테스트 완료 시 텔레그램 요약 전송 옵션.
- 설정/구성
  - 로컬 설정 파일(config.yaml) 단일 소스 사용(환경변수 오버라이드 없음).
  - 테스트넷/메인넷, 심볼, 레버리지, 주문 크기, TP/SL, 전략 파라미터, 백테스트 캔들 수(backtest_limit)와 구간(start/end)을 설정화.
- 로깅/감사
  - 구조화 로그(JSONL) + 사람 친화 로그 병행.
  - 중요 이벤트에 요청/응답 요약(민감 정보 제외)과 시그널 계산 값, 포지션 상태(수익률, 현금/코인 잔고) 기록.
  - logs/ 디렉토리에 연도별 파일 로테이션(loguru 기반) + 콘솔 출력.
- 백테스트/시뮬레이션(라이트)
  - REST 캔들로 단순 백테스트, 수수료/슬리피지 모델 포함. 최신 N개(limit) 또는 start/end 구간 지정 지원.
  - 성능 지표: PnL(USDT), 총 수익률, MDD(금액), 승률, 거래수, 현금/코인 잔고 추적, 텔레그램 요약 옵션.

## 7) 비기능 요구 사항
- 신뢰성: 프로세스 크래시 시 재시작(예: supervisor/systemd or 간단한 재시작 스크립트).
- 성능/지연: 시세 수신~주문 전송 왕복 500ms 이내(일반 조건).
- 안전성: 예상치 못한 메시지 포맷/필드 누락 시 방어적 파싱, 기본값 제한 적용.
- 보안: 키/시그니처 노출 방지, TLS 사용, 로그 마스킹, 최소 권한 API 키 사용.
- 관측성: 메트릭(주기적 PnL/노출/지연)과 로그 레벨 조정 가능.

## 8) 운영 플로우(예시)
1. 설정 로드 및 시계 동기화(API time check).
2. WebSocket 연결 후 티커/오더북 구독, 초기 스냅샷 REST 백필.
3. 전략 시그널 계산 → 주문 생성(가격/수량) → 제출 → 확인.
4. 미체결 상태 모니터링 및 리프라이스/취소; TP/SL/트레일링 관리.
5. 주기 헬스체크와 알림; 오류 누적 시 안전 청산 후 중단.

## 9) 데이터 및 API
- 주요 REST: kline, ticker/mark-price, set-leverage, set-margin-mode, place-order, cancel, get-position, get-balance.
- 주요 WebSocket: public ticker/orderbook, private position/order/execution.
- 레이트 리밋 처리: REST 초과 시 백오프 및 큐잉, WebSocket 재연결 쿨다운.
- 시간 동기화: 서버 시간 주기적 조회, 서명 시 타임스탬프 편차 확인.

## 10) 에러 및 예외 처리
- 요청 실패 재시도: HTTP 오류/429/네트워크 단절 시 지수 백오프.
- 시세/포지션 데이터 불일치 시 전체 리프레시 후 재계산.
- 치명 오류(키 불일치, 시그니처 실패, 포지션 조회 불능) 시 알림 후 자동 중단.

## 11) 설정/배포
- 환경 예: `.env` 혹은 `config.yaml`에 API 키, 엔드포인트, 심볼, 레버리지, 주문 크기, 초기 잔고, 전략 파라미터(앵커 타입/직접 입력 시점·가격, 밴드 폭, 캔들 주기, 백테스트 limit/start/end), 알림 키.
- 테스트넷 우선 배포 → 시뮬레이션 결과 검증 → 메인넷 스위치.
- 기본 실행: `python main.py` (동일 경로 config.yaml 자동 사용) 또는 `python main.py --config config.yaml`.
- 컨테이너 배포: Dockerfile + docker-compose.yml 제공, `docker compose up -d` (restart unless-stopped)로 서버 재부팅 시 자동 재시작.

## 12) 마일스톤(제안)
1. 인프라/SDK 뼈대: API 클라이언트, 키 관리, 설정 로더, 로깅.
2. 데이터 스트림: WebSocket 구독 + REST 백필, 헬스체크.
3. 주문/포지션 모듈: 레버리지/마진 모드 설정, 주문/포지션 CRUD, 안전 가드.
4. 전략 MVP 1종 + 백테스트 라이트, TP/SL/리밸런싱 로직.
5. 알림/모니터링 + 장애 복구(재연결/재시작).
6. 테스트넷 안정화 후 메인넷 시범 운용.

## 13) 테스트 및 검증
- 단위: 시그니처 생성, 주문 파라미터 검증, 슬리피지 계산, 리스크 한도.
- 통합: REST/WebSocket 목으로 주문-체결-포지션 흐름 시뮬레이션.
- 백테스트: 샘플 구간의 성능 리포트 생성(CAGR, MDD, 거래수, 손익분포).
- 카나리: 테스트넷 주말/비중요 시간대에 실거래 소액 테스트, 알림/로그 점검.
